(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class F{get elem(){return this._elem}set elem(t){this._elem=t}addChild(t){this.elem.append(t.elem)}addClass(t){this.elem.classList.add(t)}removeClass(t){this.elem.classList.remove(t)}getAttribute(t){return this.elem.getAttribute(t)}setAttribute(t,e=""){this.elem.setAttribute(t,e)}toggleAttribute(t,e){e?this.elem.setAttribute(t,""):this.elem.removeAttribute(t)}removeAttribute(t){this.elem.removeAttribute(t)}destroy(){this.elem.remove()}}class x extends F{set elem(t){this._elem=t}get elem(){return this._elem}createElement(t){this.elem=document.createElementNS("http://www.w3.org/2000/svg",t)}}const h=class h{static init(t,e){h.map=[],h.w=t,h.h=e;for(let s=0;s<t;s++)for(let i=0;i<e;i++)h.map[s+i*t]=new h(s,i);h.indexMap=new Map;for(let s=0;s<9;s++)h.indexMap.set(h.around[s],s)}static get(t,e){return h.map[t+e*h.w]}constructor(t,e){this.x=t,this.y=e}move(t,e){return h.get(this.x+t,this.y+e)}};h.Zero=new h(0,0),h.Right=new h(1,0),h.UpRight=new h(1,-1),h.Up=new h(0,-1),h.UpLeft=new h(-1,-1),h.Left=new h(-1,0),h.DownLeft=new h(-1,1),h.Down=new h(0,1),h.DownRight=new h(1,1),h.around=[h.Right,h.UpRight,h.Up,h.UpLeft,h.Left,h.DownLeft,h.Down,h.DownRight,h.Zero];let w=h;class u{static toNumber64(t){let e=[],s=t.length;for(let i=0;i<s;i++){let r=t.charCodeAt(i);r<48?e.push(r+17):r<58?e.push(r-48):r<91?e.push(r-29):e.push(r-87)}return e}static toString64(...t){let e="";for(let s of t)s<10?e+=s:s<36?e+=String.fromCharCode(s+87):s<62?e+=String.fromCharCode(s+29):e+=String.fromCharCode(s-17);return e}static shuffle(t){for(let e=t.length-1;0<e;e--){let s=Math.floor(Math.random()*(e+1)),i=t[e];t[e]=t[s],t[s]=i}return t}static getRandom(t){return t[Math.floor(Math.random()*t.length)]}static getShuffled(t){let e=t.concat();for(let s=t.length-1;0<s;s--){let i=Math.floor(Math.random()*(s+1)),r=e[s];e[s]=e[i],e[i]=r}return e}static or(t,e){for(let s of e)if(t==s)return!0;return!1}static getUnion(t,e){return new Set([...t,...e])}static getIntersection(t,e){return new Set([...t].filter(s=>e.has(s)))}static getDifference(t,e){return new Set([...t].filter(s=>!e.has(s)))}static exceptWith(t,e){for(let s of e)t.delete(s)}static unionWith(t,e){for(let s of e)t.add(s)}static isSubset(t,e){for(let s of e)if(!t.has(s))return!1;return!0}static getCombination(t){let e=t.size,s=[],i=0;for(let r of t){let l=i-1;for(let o=0;o<i;o++)s[l][1]=r,l+=e-o-2;i++;for(let o=0;o<e-i;o++)s.push([r,null])}return s}static sleep(t){return new Promise(e=>setTimeout(e,t))}}const d=class d{static getOpposite(t){return t==d.Colored?d.White:t==d.White?d.Colored:d.Empty}};d.Unknown=-2,d.Empty=-1,d.Colored=0,d.White=1,d.ColoredAndWhite=[d.Colored,d.White];let n=d;class U{constructor(){}check(t){return!1}}class W extends U{constructor(){super(),this.name="Line Balance",W.I=this}check(t){for(let e of t.getLines()){let s=e.length/2,i=0,r=0;for(let l of e)l.state==n.Empty?r++:i+=l.state;if(i>s||i+r<s)return!1}return!0}}class $ extends U{constructor(t){super(),this.name="No Straight",this.length=t,$.I=this}check(t){for(let e of t.getLines()){let s,i;for(let r of e)if(r.state!=n.Empty&&r.state==s){if(i++,i==this.length)return!1}else s=r.state,i=1}return!0}}class m extends U{constructor(t=!0,e=!0){super(),this.name="unique",m.I=this,this.checkRow=t,this.checkColumn=e,this.hashSet=new Set}check(t){for(let e of n.ColoredAndWhite){if(this.checkRow){this.hashSet.clear();for(let s of t.rows){let i=s.getHash(e,s.length/2);if(i!=-1&&this.hashSet.has(i))return!1;this.hashSet.add(i)}}if(this.checkColumn){this.hashSet.clear();for(let s of t.columns){let i=s.getHash(e,s.length/2);if(i!=-1&&this.hashSet.has(i))return!1;this.hashSet.add(i)}}}return!0}}class b{constructor(){b.I=this,this.rules=[],this.rules.push(new $(3)),this.rules.push(new W),this.rules.push(new m)}check(t){for(let e of this.rules)if(!e.check(t))return!1;return!0}}class S extends Array{getHash(t,e){let s=0,i=0;for(let r=0;r<this.length;r++)this[r].state==t&&(i++,s+=Math.pow(2,r));return i==e?s:-1}getRandom(t=this.length){let e=[...this];return u.shuffle(e),e.length=t,e}}class v extends Set{isSubset(t,e=!1){for(let s of this)if(!t.has(s))return!1;return!(!e&&this.size==t.size)}exceptWith(t){for(let e of t)this.delete(e)}getExcept(t){let e=new v;for(let s of this)t.has(s)||e.add(s);return e}unionWith(t){for(let e of t)this.add(e)}getRandom(t=this.size){let e=[...this];return u.shuffle(e),e.length=t,e}}class A{*apply(t){yield null}}class P extends A{constructor(){super(),this.name="Eliminate",P.I=this,this.emptyCellSet=new v,this.fixedCellSet=new v}*apply(t){for(let e of t.getLines())for(let s of n.ColoredAndWhite){this.fixedCellSet.clear(),this.emptyCellSet.clear(),this.set3s=[];let i=0;t:for(let r=0;r<e.length;r++){let l=e[r];if(l.state==s?i++:l.state==n.Empty&&this.emptyCellSet.add(l),r+2>=e.length)continue;let o=new v;for(let c=0;c<3;c++){if(l=e[r+c],l.state==s)continue t;l.state==n.Empty&&o.add(l)}this.set3s.push(o)}if(this.score=this.emptyCellSet.size,this.eliminate(i-e.length/2),this.fixedCellSet.size!=0){for(let r of this.fixedCellSet)r.state=n.getOpposite(s),yield r;return}}}eliminate(t){if(t>=0){for(let e of this.emptyCellSet)this.fixedCellSet.add(e);return}for(let e of this.set3s)e.isSubset(this.emptyCellSet)&&(this.emptyCellSet.exceptWith(e),this.eliminate(t+1),this.emptyCellSet.unionWith(e))}}class H extends A{constructor(){super(),this.name="Line Balance",H.I=this,this.score=0}*apply(t){for(let e of t.getLines()){let s=e.length/2,i=new S,r=0;for(let l of e)l.state==n.Empty?i.push(l):r+=l.state;if(i.length!=0){let l=n.Empty;if(r==s?l=n.Colored:r+i.length==s&&(l=n.White),l!=n.Empty){for(let o of i)o.state=l,yield o;return}}}}}class N extends A{constructor(t){super(),this.name="No Straight",N.I=this,this.length=t,this.score=0}*apply(t){for(let e of t.getLines())t:for(let s=0;s<e.length-this.length+1;s++){let i=null,r=-2;for(let l=0;l<this.length;l++){let o=e[s+l];if(o.state==n.Empty){if(i)continue t;i=o}else if(r==-2)r=o.state;else if(r!=o.state)continue t}i&&(i.state=n.getOpposite(r),yield i)}}}class z extends A{constructor(t){super(),this.name="Unique",this.tacticLv=[0,2,3,1,2,3],z.I=this,this.maxLv=t}*apply(t){for(let e=0;e<this.maxLv;e++)for(let s of t.getLines())for(let i of s)if(i.state==n.Empty)for(let r of n.ColoredAndWhite){i.state=r;let l=g.I.applyTactics(s,this.tacticLv[e]);if(e<3&&(s.w==1?m.I.checkRow=!1:m.I.checkColumn=!1),m.I.check(t)?i.state=n.Empty:i.state=n.getOpposite(r),m.I.checkRow=m.I.checkColumn=!0,l.forEach(o=>o.state=n.Empty),i.state!=n.Empty){this.score=e*5,this.name="Unique Lv."+(e+1)+"      ",yield i;return}}}}class g{constructor(){g.I=this,this.tactics=[],this.tactics.push(new N(3)),this.tactics.push(new H),this.tactics.push(new P),this.tactics.push(new z(6))}applyTactics(t,e=this.tactics.length){e=Math.min(e,this.tactics.length);let s=new S;for(let i=0;i<e;i++){let r=this.tactics[i];for(let l of r.apply(t))s.push(l),i=-1}return s}}class C{constructor(){this.temps=[[0,1],[1,0]],C.I=this}async createBinairo(t,e=0){for await(let s of this.create(t,e))if(await u.sleep(0),s)break;t.forEach(s=>s.object.draw())}async*create(t,e){for(;this.createBoard(t),this.reduceHint(t),this.solve(t,!1),!(this.score>=e);)t.forEach(s=>s.state=n.Empty),yield!1;yield!0}createBoard(t,e=0){for(let s of t)if(s.state==n.Empty){let i=Math.floor(Math.random()*2);for(let r of this.temps[i]){s.state=r;let l=g.I.applyTactics(t,2);if(b.I.check(t)){if(e+1+l.length==t.length)return t.forEach(o=>o.answer=o.state),!0;if(this.createBoard(t,e+1+l.length))return!0}s.state=n.Empty,l.forEach(o=>o.state=n.Empty)}return!1}}reduceHint(t){let e=0;for(let s of t.getRandom()){s.state=n.Empty,e++;let i=g.I.applyTactics(t);i.length!=e&&(s.state=s.answer,e--),i.forEach(r=>r.state=n.Empty)}}solve(t,e=!0){let s=new S,i=g.I.tactics.length,r=!1,l="";if(this.score=0,!b.I.check(t))r=!0;else t:for(let c=0;c<i;c++){let E=g.I.tactics[c];for(let k of E.apply(t)){if(e&&(l+=E.name+":"+k.x+","+k.y+" = "+k.state+`
`),this.score+=E.score,s.push(k),!b.I.check(t)){r=!0;break t}c=-1}}let o=t.isCompleted();r?console.log("invalid"):(o&&(console.log(l),console.log("score:"+this.score)),t.log()),s.forEach(c=>c.state=n.Empty),!r&&o&&t.logData()}}class G{constructor(t,e){this.state=n.Empty,this.answer=n.Empty,this.x=t,this.y=e,this.edges=new Array(8)}}class K extends v{constructor(){super()}addCell(t){t.region=this,this.add(t)}}class j extends S{constructor(t,e){if(super(t*e),this.w=t,this.h=e,this.w>1&&this.h>1){this.columns=[];for(let s=0;s<t;s++)this.columns[s]=new j(1,e);this.rows=[];for(let s=0;s<e;s++)this.rows[s]=new j(t,1)}for(let s=0;s<this.w;s++)for(let i=0;i<this.h;i++){let r=new G(s,i);this[s+i*this.w]=r,this.w>1&&this.h>1&&(this.columns[s][i]=r,this.rows[i][s]=r)}}get(t,e){return this.isIn(t,e)?this[t+e*this.w]:null}isIn(t,e){return!(t<0||e<0||t>=this.w||e>=this.h)}*getLines(){if(this.w>1&&this.h>1){for(let t of this.columns)yield t;for(let t of this.rows)yield t}else yield this}createRegion(){this.regions=[];for(let t of this)if(!t.region){let e=new K;this.regions.push(e),this.dfsForRegion(t,e)}}dfsForRegion(t,e){e.addCell(t);for(let s=0;s<8;s+=2)if(!t.edges[s].isBorder){let i=this.get(t.x+w.around[s].x,t.y+w.around[s].y);i&&!i.region&&this.dfsForRegion(i,e)}}isCompleted(){for(let t of this)if(t.state==n.Empty)return!1;return!0}logAnswer(){let t="";for(let e=0;e<this.h;e++){for(let s=0;s<this.w;s++)switch(this.get(s,e).answer){case n.Unknown:t+="？";break;case n.Empty:t+="ｘ";break;case n.Colored:t+="■";break;case n.White:t+="□";break}t+=`
`}console.log(t)}log(){let t="";for(let e=0;e<this.h;e++){for(let s=0;s<this.w;s++)switch(this.get(s,e).state){case n.Empty:t+="・";break;case n.Colored:t+="■";break;case n.White:t+="□";break}t+=`
`}console.log(t)}logData(){let t=u.toString64(this.w)+u.toString64(this.h),e=0,s=0;for(let i=0;i<this.h;i++)for(let r=0;r<this.w;r++)s==this.get(r,i).state?(e++,e==9&&(t+=u.toString64(e+52),e=0)):(e!=0&&(e==1?s==-1?t+="-":t+=s:t+=u.toString64(e+52)),s=this.get(r,i).state,e=0,s==-1?t+="-":t+=s);return console.log("data:"+t),t}}class R extends x{constructor(){super(),this.d="",this.createElement("path")}draw(){this.elem.setAttribute("d",this.d)}}const L=class L{constructor(){document.addEventListener("pointerdown",t=>{L.isPointerDown=!0}),document.addEventListener("pointerup",t=>{L.isPointerDown=!1})}};L.isPointerDown=!1;let O=L;class J extends Set{constructor(){super()}createLine(...t){this.lines=[];for(let e=0;e<t.length;e++)this.lines.push(new Q(t[e],e==t.length-1?t[0]:t[e+1]));for(let e=0;e<this.lines.length;e++){let s=this.lines[e];s.prev=this.lines[e-1],s.next=e==this.lines.length-1?this.lines[0]:this.lines[e+1]}this.lines[0].prev=this.lines[this.lines.length-1];for(let e=0;e<this.lines.length;e++)this.addLine(this.lines[e])}addLine(t){this.firstLine||(this.firstLine=t);let e;for(let s of this)s.to==t.from&&s.from==t.to&&(e=s);e?(e.prev.next=t.next,e.next.prev=t.prev,t.prev.next=e.next,t.next.prev=e.prev,this.delete(e)):this.add(t)}getPath(){let t=this.firstLine,e=`M ${t.from.x} ${t.from.y} `;do e+=`L ${t.to.x} ${t.to.y} `,t=t.next;while(t&&t!=this.firstLine);return e+=" Z",e}}class Q{constructor(t,e){this.from=t,this.to=e}}class q{constructor(t,e){this.cellObject=t,this.from=this.cellObject.cell.state,this.to=e}}class y{constructor(){this.turn=0,y.I=this,this.operations=[],this.updateBtns()}do(t){this.operations.length>this.turn&&this.operations.splice(this.turn,this.operations.length-this.turn),this.turn!=0&&this.operations[this.turn-1].cellObject==t.cellObject?this.operations[this.turn-1].from==t.to?(this.operations.pop(),this.turn--):this.operations[this.turn-1].to=t.to:(this.operations.push(t),this.turn++),t.cellObject.updateState(t.to),this.updateBtns()}redo(){if(this.turn==this.operations.length)return;let t=this.operations[this.turn];t.cellObject.updateState(t.to),this.turn++,this.updateBtns()}undo(){if(this.turn==0)return!1;let t=this.operations[this.turn-1];return t.cellObject.updateState(t.from),this.turn--,this.updateBtns(),!0}reset(){for(;this.undo(););this.updateBtns()}updateBtns(){}}const p=class p extends x{constructor(t){super(),this.cell=t,t.object=this,this.createElement("g"),this.addClass("cell");let e=w.get(t.x,t.y);this.path=new J,this.path.createLine(e,e.move(1,0),e.move(1,1),e.move(0,1)),this.body=new R,this.body.addClass("body"),this.addChild(this.body),this.overlay=new R,this.overlay.addClass("overlay"),this.addChild(this.overlay),this.elem.addEventListener("pointerdown",s=>{s.isPrimary&&this.onDown(s)}),this.elem.addEventListener("pointerup",s=>{s.isPrimary&&this.onUp(s)}),this.elem.addEventListener("pointerover",s=>{s.isPrimary&&this.onOver(s)}),this.elem.addEventListener("pointerout",s=>{s.isPrimary&&this.onOut(s)})}union(t){if(t.cell.object!=this){t.cell.object=this;for(let e of t.path.lines)this.path.addLine(e);t.destroy()}}drawPath(){this.body.d=this.overlay.d=this.path.getPath(),this.body.draw(),this.overlay.draw()}lock(t){this.isLocked=t}updateState(t){this.cell.state=t,this.draw()}draw(){this.setAttribute("state",""+this.cell.state)}onDown(t){p.pointerTarget=this,this.elem.releasePointerCapture(t.pointerId);let e=this.cell.state+(t.button==0?1:-1);e==2?e=-1:e==-2&&(e=1),p.pointerState=e,y.I.do(new q(this,p.pointerState)),f.I.onCellChange()}onUp(t){}onOver(t){this.addClass("hover"),!(!O.isPointerDown||this.cell.state==p.pointerState)&&(y.I.do(new q(this,p.pointerState)),f.I.onCellChange())}onOut(t){this.removeClass("hover")}};p.innerSize=.2;let D=p;class V{constructor(t,e){this.isBorder=!1,this.isUnion=!1,this.cells=new S,this.x=t,this.y=e}setBorder(t){this.isBorder=t,this.object.toggleAttribute("border",t)}setUnion(t){this.isUnion=t,this.object.toggleAttribute("union",t)}}class X extends Array{constructor(t,e){super((t*2+1)*(e*2+1)),this.w=t*2+1,this.h=e*2+1;for(let s=0;s<this.w;s++)for(let i=0;i<this.h;i++){let r=new V(s,i);this[s+i*this.w]=r}}get(t,e){return this.isIn(t,e)?this[t+e*this.w]:null}isIn(t,e){return!(t<0||e<0||t>=this.w||e>=this.h)}}class Y extends R{constructor(t){super(),this.addClass("edge"),this.edge=t,t.object=this}drawEdge(){let t=this.edge.x,e=this.edge.y;t%2==0?this.d=`M${t/2},${e/2-.5} L${t/2},${e/2+.5}`:this.d+=`M${t/2-.5},${e/2} L${t/2+.5},${e/2}`,this.draw()}}class f extends x{constructor(){super(),this.checkTimeout=-1,this.error=!1,f.I=this,this.createElement("g"),this.addClass("board"),this.cellMapObject=new x,this.cellMapObject.createElement("g"),this.cellMapObject.addClass("cellMap"),this.addChild(this.cellMapObject),this.edgeMapObject=new x,this.edgeMapObject.createElement("g"),this.edgeMapObject.addClass("edgeMap"),this.addChild(this.edgeMapObject)}load(t){let e=u.toNumber64(t);this.w=e[0],this.h=e[1],this.cellMap=new j(this.w,this.h);for(let l=0;l<this.w;l++)for(let o=0;o<this.h;o++){let c=this.cellMap.get(l,o),E=new D(c);this.cellMapObject.addChild(E)}let s=0,i=0,r=0;for(let l=2;l<e.length;l++){let o=e[l],c=this.cellMap[s];r==0?o>=62?i=n.Empty:o>=54?r=o-53:i=o:(r--,l--),i!=n.Empty&&(c.state=i,c.object.draw(),c.object.lock(!0)),s++}}loadEdge(t){let e=u.toNumber64(t);this.edgeMap=new X(this.w,this.h);for(let s=0;s<this.w*2+1;s++)for(let i=0;i<this.h*2+1;i++){let r=this.edgeMap.get(s,i);if((s%2+i%2)%2==1){let l=new Y(r);(s==0||i==0||s==this.w*2||i==this.h*2)&&r.setBorder(!0),l.drawEdge(),this.edgeMapObject.addChild(l)}}for(let s of this.cellMap)for(let i=0;i<8;i++){let r=this.edgeMap.get(s.x*2+1+w.around[i].x,s.y*2+1+w.around[i].y);r.cells.push(s),s.edges[i]=r}for(let s=0;s<e.length;s++){let i=e[s],r=this.cellMap[s];i&1&&(r.object.union(this.cellMap[s+1].object),r.edges[0].setUnion(!0)),i&2&&(r.object.union(this.cellMap[s+this.w].object),r.edges[6].setUnion(!0)),i&4&&r.edges[0].setBorder(!0),i&8&&r.edges[6].setBorder(!0)}this.cellMap.createRegion();for(let s of this.cellMap)s.object.drawPath()}onCellChange(){C.I.solve(this.cellMap,!1)}checkError(){this.error=!b.I.check(this.cellMap),this.error&&console.log("error"),this.toggleAttribute("error",this.error)}getHint(){C.I.solve(this.cellMap)}}class I extends x{constructor(){super(),this.padding=[0,0,0,0],I.I=this,this.createElement("svg"),this.addClass("boardWrapper")}addBoard(t,e,s,i){this.addChild(f.I);let r=f.I.w+t+s,l=f.I.h+e+i;f.I.elem.style.transform=`translate(${s}px, ${e}px)`,this.elem.setAttribute("viewBox",`0 0 ${r} ${l}`)}}class Z extends F{set elem(t){this._elem=t}get elem(){return this._elem}createElement(t){this.elem=document.createElement(t)}}class B extends Z{constructor(){super(),B.I=this,this.elem=document.querySelector("#game"),this.elem.addEventListener("touchmove",t=>{t.touches.length==1&&t.preventDefault()}),this.elem.addEventListener("touchend",this.preventDefault),this.elem.addEventListener("touchcancel",this.preventDefault),this.elem.addEventListener("contextmenu",this.preventDefault)}preventDefault(t){t.preventDefault()}}class M extends Z{constructor(t){super(),this.isActive=!0,this.elem=document.querySelector("#"+t),this.elem.addEventListener("click",()=>{this.isActive&&this.onClick()})}onClick(){}setActive(t){this.isActive=t,t?this.removeAttribute("deactive"):this.setAttribute("deactive")}}class _ extends M{onClick(){f.I.getHint()}}class tt extends M{onClick(){y.I.redo(),f.I.onCellChange()}}class et extends M{onClick(){y.I.reset(),f.I.onCellChange()}}class st extends M{onClick(){y.I.undo(),f.I.onCellChange()}}class T{constructor(){T.I=this,this.undoBtn=new st("undo"),this.redoBtn=new tt("redo"),this.resetBtn=new et("reset"),this.hintBtn=new _("hint")}}document.addEventListener("DOMContentLoaded",a=>{w.init(30,30),new B,new T,new O,new I,new f,new y,new b,new g,new C,f.I.load("88"),f.I.loadEdge(""),C.I.createBinairo(f.I.cellMap,50),I.I.addBoard(0,0,0,0),B.I.addChild(I.I)});
